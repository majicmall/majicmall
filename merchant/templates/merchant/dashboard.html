{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Merchant Dashboard | Majic Mall</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .line-clamp-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 1;
    }
    .nav-active { position: relative; color: #facc15; }
    .nav-active::after {
      content: ""; position: absolute; left: 0; bottom: -4px;
      width: 100%; height: 2px; background: #facc15; border-radius: 1px;
    }
    .spark svg { display: block; }
  </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">

  {% include "merchant/_nav.html" %}

  {% if messages %}
    <div class="max-w-6xl mx-auto px-6 mt-4 space-y-2">
      {% for message in messages %}
        <div class="rounded-xl px-4 py-3
                    {% if message.tags == 'success' %}bg-green-900/40 text-green-200
                    {% elif message.tags == 'error' %}bg-red-900/40 text-red-200
                    {% else %}bg-gray-800 text-gray-200{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <main class="max-w-6xl mx-auto px-6 py-8">
    <div class="flex items-center justify-between mb-4">
      <div></div>
      <a href="/" class="px-4 py-2 rounded-xl bg-gray-800 text-yellow-400 hover:bg-gray-700" aria-label="Back to Mall">
        ‚Üê Back to Mall
      </a>
    </div>

    {% if store and store.slug %}
      <div class="mt-4">
        <a
          href="{% url 'storefront' store.slug %}"
          target="_blank"
          rel="noopener"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-yellow-400 text-black hover:opacity-90"
          title="Open your public storefront in a new tab"
        >
          <span aria-hidden="true">üëÅÔ∏è</span>
          <span>View Storefront</span>
        </a>
      </div>
    {% endif %}

    <!-- Welcome -->
    <section class="mb-8">
      <h2 class="text-3xl font-bold mb-2">
        Welcome, {{ merchant.display_name|default:user.get_username }}
      </h2>
      <p class="text-gray-400">Here‚Äôs an overview of your store performance and tools.</p>
    </section>

    <a href="{% url 'merchant-plans' %}" class="px-3 py-2 rounded-lg text-sm font-medium hover:text-white hover:bg-zinc-800">
      Plans & Pricing
    </a>

    <!-- Store Brand Header -->
    <section class="mb-8 bg-gray-900 rounded-2xl p-6 flex items-center gap-5">
      {% if store.logo %}
        <img src="{{ store.logo.url }}" alt="{{ store.store_name }}" class="h-16 w-16 rounded-xl object-cover shadow" />
      {% else %}
        <div class="h-16 w-16 rounded-xl bg-gray-800 grid place-items-center text-gray-400">üè¨</div>
      {% endif %}

      <div class="flex-1">
        <h2 class="text-2xl font-bold text-yellow-400">{{ store.store_name }}</h2>
        {% if store.slogan %}
          <p class="text-gray-400">{{ store.slogan }}</p>
        {% elif store.description %}
          <p class="text-gray-400 line-clamp-1">{{ store.description }}</p>
        {% endif %}
      </div>

      {% if store %}
        <a href="{% url 'merchant-profile' %}"
           class="px-4 py-2 bg-gray-800 text-yellow-400 rounded-xl hover:bg-gray-700">
          ‚úèÔ∏è Customize Store
        </a>
      {% else %}
        <a href="{% url 'merchant-setup' %}"
           class="px-4 py-2 bg-gray-800 text-yellow-400 rounded-xl hover:bg-gray-700">
          üöÄ Create Store
        </a>
      {% endif %}
    </section>

    <!-- Stats -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
      <div class="bg-gray-900 p-6 rounded-2xl shadow">
        <div class="text-center">
          <div class="text-3xl mb-2">üì¶</div>
          <p class="text-gray-400">Products</p>
          <p class="text-3xl font-bold text-yellow-400">{{ product_count|default:"0" }}</p>
        </div>
        <div class="spark text-yellow-400 mt-4" data-points="{{ product_spark|default:'' }}"></div>
      </div>

      <a href="{% url 'order-list' %}" class="block">
        <div class="bg-gray-900 p-6 rounded-2xl shadow hover:bg-gray-800 transition">
          <div class="text-center">
            <div class="text-3xl mb-2">üßæ</div>
            <p class="text-gray-400">Orders</p>
            <p class="text-3xl font-bold text-yellow-400">{{ order_count|default:"0" }}</p>
          </div>
          <div class="spark text-yellow-400 mt-4" data-points="{{ order_spark|default:'' }}"></div>
        </div>
      </a>

      <div class="bg-gray-900 p-6 rounded-2xl shadow">
        <div class="text-center">
          <div class="text-3xl mb-2">üí∞</div>
          <p class="text-gray-400">Revenue</p>
          <p class="text-3xl font-bold text-yellow-400">${{ revenue|default:0|floatformat:2 }}</p>
        </div>
        <div class="spark text-yellow-400 mt-4" data-points="{{ revenue_spark|default:'' }}"></div>
      </div>
    </section>

    <!-- Recent Orders -->
    <section class="mb-10">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Recent Orders</h3>
        <a href="{% url 'order-list' %}" class="text-yellow-400 hover:underline">View all ‚Üí</a>
      </div>

      <div class="overflow-x-auto bg-gray-900 rounded-2xl shadow">
        <table class="min-w-full text-left">
          <thead class="bg-gray-800 text-gray-300 uppercase text-sm">
            <tr>
              <th class="px-6 py-3">Order</th>
              <th class="px-6 py-3">Status</th>
              <th class="px-6 py-3">Date</th>
              <th class="px-6 py-3">Total</th>
              <th class="px-6 py-3">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-800">
            {% for order in recent_orders %}
            <tr class="hover:bg-gray-800">
              <td class="px-6 py-3">#{{ order.id }}</td>
              <td class="px-6 py-3">{{ order.status|title }}</td>
              <td class="px-6 py-3">{{ order.created_at|date:"M d, Y" }}</td>
              <td class="px-6 py-3">${{ order.total|floatformat:2 }}</td>
              <td class="px-6 py-3">
                <a href="{% url 'order-detail' order.id %}" class="text-yellow-400 hover:underline">View</a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="px-6 py-6 text-center text-gray-400">
                No orders yet. <a href="{% url 'order-list' %}" class="text-yellow-400 hover:underline">See all</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="mb-10">
      <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
      <div class="flex flex-wrap gap-4">
        <a href="{% url 'add-product' %}" class="px-5 py-3 bg-yellow-400 text-black rounded-xl shadow hover:opacity-90">
          ‚ûï Add Product
        </a>
        <a href="{% url 'merchant-profile' %}" class="px-5 py-3 bg-gray-800 text-yellow-400 rounded-xl shadow hover:bg-gray-700">
          ‚úèÔ∏è Customize Store
        </a>
        <a href="{% url 'order-list' %}" class="px-5 py-3 bg-gray-800 text-yellow-400 rounded-xl shadow hover:bg-gray-700">
          üì¶ View Orders
        </a>
        <a href="{% url 'merchant-reports' %}" class="px-5 py-3 bg-gray-800 text-yellow-400 rounded-xl shadow hover:bg-gray-700">
          üìä View Reports
        </a>
      </div>
    </section>

    <!-- Products Table -->
    <section>
      <h3 class="text-xl font-semibold mb-4">Your Products</h3>
      <div class="overflow-x-auto bg-gray-900 rounded-2xl shadow">
        <table class="min-w-full text-left">
          <thead class="bg-gray-800 text-gray-300 uppercase text-sm">
            <tr>
              <th class="px-6 py-3">Name</th>
              <th class="px-6 py-3">Price</th>
              <th class="px-6 py-3">Created</th>
              <th class="px-6 py-3">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-800">
            {% for product in products %}
            <tr class="hover:bg-gray-800">
              <td class="px-6 py-3">
                <div class="flex items-center gap-3">
                  {% if product.image %}
                    <img src="{{ product.image.url }}" class="h-8 w-8 rounded object-cover" alt="">
                  {% else %}
                    <div class="h-8 w-8 rounded bg-gray-800 grid place-items-center text-xs text-gray-400">üì¶</div>
                  {% endif %}
                  <span>{{ product.name }}</span>
                </div>
              </td>
              <td class="px-6 py-3">
                {% if product.price %}
                  ${{ product.price|floatformat:2 }}
                {% else %}
                  $0.00
                {% endif %}
              </td>
              <td class="px-6 py-3">{{ product.created_at|date:"M d, Y" }}</td>
              <td class="px-6 py-3 space-x-2">
                <a href="{% url 'edit-product' product.id %}" class="text-yellow-400 hover:underline">Edit</a>
                <a href="{% url 'delete-product' product.id %}" class="text-red-400 hover:underline">Delete</a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="px-6 py-6 text-center text-gray-400">
                No products yet. <a href="{% url 'add-product' %}" class="text-yellow-400 hover:underline">Add your first product</a>.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    (function () {
      function drawSpark(el, points) {
        const w = 220, h = 40, p = 4;
        if (!points || points.length < 2) {
          points = Array.from({length: 16}, (_, i) => {
            const base = 50 + 30 * Math.sin(i / 2);
            const jitter = Math.random() * 15 - 7.5;
            return Math.max(0, base + jitter);
          });
        }
        const min = Math.min(...points);
        const max = Math.max(...points);
        const span = (max - min) || 1;
        const stepX = (w - 2*p) / (points.length - 1);
        const mapY = v => h - p - ((v - min) / span) * (h - 2*p);
        let d = "";
        points.forEach((v, i) => {
          const x = p + i * stepX;
          const y = mapY(v);
          d += (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
        });
        el.innerHTML = `
          <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
            <line x1="0" y1="${h-1}" x2="${w}" y2="${h-1}" stroke="rgba(255,255,255,0.08)" />
            <path d="${d}" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        `;
      }
      document.querySelectorAll('.spark').forEach(el => {
        const raw = (el.getAttribute('data-points') || '').trim();
        let points = null;
        if (raw) {
          try {
            points = raw.startsWith('[') ? JSON.parse(raw) : raw.split(',').map(x => parseFloat(x));
            if (!Array.isArray(points)) points = null;
          } catch (e) { points = null; }
        }
        drawSpark(el, points);
      });
    })();
  </script>
</body>
</html>
