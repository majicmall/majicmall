{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ store.store_name }} | Majic Mall</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0b0b0b">

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ store.store_name }} | Majic Mall">
  <meta property="og:description" content="{{ store.slogan|default:store.description|default:'Shop this storefront on Majic Mall.' }}">
  <meta property="og:url" content="{{ request.build_absolute_uri }}">
  {% if store.logo %}
    <meta property="og:image" content="{{ store.logo.url }}">
    <meta name="twitter:image" content="{{ store.logo.url }}">
  {% endif %}
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ store.store_name }} | Majic Mall">
  <meta name="twitter:description" content="{{ store.slogan|default:store.description|default:'Shop this storefront on Majic Mall.' }}">

  <!-- Canonical -->
  <link rel="canonical" href="{{ request.build_absolute_uri }}">

  <!-- JSON-LD (Store) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Store",
    "name": "{{ store.store_name|escapejs }}",
    {% if store.logo %}"image": ["{{ store.logo.url }}"],{% endif %}
    {% if store.description %}"description": "{{ store.description|striptags|truncatechars:180|escapejs }}",{% endif %}
    "url": "{{ request.build_absolute_uri }}",
    "brand": {"@type":"Brand","name":"{{ store.store_name|escapejs }}"}
  }
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { box-shadow: 0 6px 24px rgba(0,0,0,.35); }
    .glass { background: rgba(24,24,27,.6); backdrop-filter: blur(8px); }
    .btn { transition: transform .08s ease; }
    .btn:active { transform: translateY(1px) scale(.99); }
    .ellipsis-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 2;
    }
  </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">

  <!-- Sticky top bar -->
  <div class="glass sticky top-0 z-30 border-b border-gray-800/70">
    <div class="max-w-6xl mx-auto px-6 py-3 flex items-center justify-between">
      <a href="/" class="inline-flex items-center gap-2 text-sm text-gray-300 hover:text-yellow-400">
        ‚Üê Back to Mall
      </a>

      <!-- Share bar -->
      <div class="flex items-center gap-2">
        <button id="copyLinkBtn"
          class="btn px-3 py-1.5 rounded-lg bg-gray-800 text-yellow-400 hover:bg-gray-700 text-sm">
          Copy Link
        </button>
        <button id="webShareBtn"
          class="btn px-3 py-1.5 rounded-lg bg-gray-800 text-yellow-400 hover:bg-gray-700 text-sm hidden md:inline-flex">
          Share‚Ä¶
        </button>
        <button id="qrBtn"
          class="btn px-3 py-1.5 rounded-lg bg-yellow-400 text-black hover:opacity-90 text-sm">
          Show QR
        </button>
      </div>
    </div>
  </div>

  <!-- Header / Branding -->
  <header class="bg-gray-900/70 border-b border-gray-800">
    <div class="max-w-6xl mx-auto px-6 py-6 flex items-center gap-4">
      {% if store.logo %}
        <img src="{{ store.logo.url }}" alt="{{ store.store_name }}" class="h-16 w-16 rounded-xl object-cover card" />
      {% else %}
        <div class="h-16 w-16 rounded-xl bg-gray-800 grid place-items-center text-gray-400 card">üè¨</div>
      {% endif %}

      <div class="flex-1">
        <h1 class="text-2xl md:text-3xl font-black text-yellow-400">{{ store.store_name }}</h1>
        {% if store.slogan %}
          <p class="text-gray-300">{{ store.slogan }}</p>
        {% elif store.description %}
          <p class="text-gray-400 ellipsis-2">{{ store.description }}</p>
        {% endif %}
      </div>

      <!-- Mini QR trigger (desktop) -->
      <button id="qrBtn2" class="hidden md:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-gray-800 text-yellow-400 hover:bg-gray-700">
        <span>QR</span><span aria-hidden="true">üîó</span>
      </button>
    </div>
  </header>

  <!-- Products -->
  <main class="max-w-6xl mx-auto px-6 py-10">
    <h2 class="text-xl font-semibold mb-6">Products</h2>

    {% if products %}
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        {% for product in products %}
          <div class="bg-gray-900 rounded-xl card p-4 flex flex-col group">
            {% if product.image %}
              <img src="{{ product.image.url }}" alt="{{ product.name }}"
                   class="h-44 w-full object-cover rounded-lg mb-4">
            {% else %}
              <div class="h-44 w-full bg-gray-800 grid place-items-center text-gray-400 rounded-lg mb-4">
                üì¶
              </div>
            {% endif %}
            <h3 class="font-semibold text-lg text-yellow-400">{{ product.name }}</h3>
            <p class="text-gray-400 text-sm flex-1">{{ product.description|default:""|truncatewords:22 }}</p>
            <div class="mt-3 flex items-center justify-between">
              <span class="text-xl font-bold">
                {% if product.price %}${{ product.price|floatformat:2 }}{% else %}$0.00{% endif %}
              </span>
              <button class="btn px-3 py-1.5 bg-yellow-400 text-black rounded-lg hover:opacity-90">
                Add to Cart
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="bg-gray-900 rounded-xl p-6 text-gray-300">
        This store doesn‚Äôt have any products yet.
      </div>
    {% endif %}
  </main>

  <footer class="bg-gray-900 py-6 mt-10 text-center text-gray-500">
    ¬© {{ store.store_name }} on Majic Mall
  </footer>

  <!-- QR Modal -->
  <div id="qrModal" class="fixed inset-0 hidden items-center justify-center z-40">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative bg-gray-900 border border-gray-800 rounded-2xl p-6 mx-4 card w-[min(92vw,520px)]">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Share this storefront</h3>
        <button id="qrClose" class="text-gray-400 hover:text-white">‚úï</button>
      </div>
      <div class="flex flex-col md:flex-row gap-6">
        <div class="bg-white rounded-xl p-3 self-center">
          <img id="qrImg"
               src="{% url 'storefront-qr' store.slug %}?box=1&size=8"
               alt="QR to {{ store.store_name }}" class="h-48 w-48 object-contain">
        </div>
        <div class="flex-1">
          <label class="block text-sm text-gray-300 mb-1">Public URL</label>
          <div class="flex items-center gap-2">
            <input id="shareUrl" class="w-full bg-gray-800 rounded-xl px-3 py-2 text-sm"
                   value="{{ request.build_absolute_uri }}" readonly>
            <button id="copyLinkBtn2"
              class="btn px-3 py-2 bg-gray-800 text-yellow-400 rounded-xl hover:bg-gray-700 text-sm">
              Copy
            </button>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <a class="btn px-3 py-2 bg-gray-800 text-yellow-400 rounded-xl hover:bg-gray-700 text-sm"
               href="{% url 'storefront-qr' store.slug %}?box=1&size=12&download=1"
               download="majicmall-store-{{ store.slug }}.png">
              Download PNG
            </a>
            <button id="sysShareBtn"
              class="btn px-3 py-2 bg-gray-800 text-yellow-400 rounded-xl hover:bg-gray-700 text-sm">
              Share‚Ä¶
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-2">Tip: print the QR on flyers, posters, table tents.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const url = "{{ request.build_absolute_uri }}";
      const copyBtns = [document.getElementById('copyLinkBtn'), document.getElementById('copyLinkBtn2')].filter(Boolean);
      copyBtns.forEach(btn => btn.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(url); btn.textContent = 'Copied!'; }
        catch { btn.textContent = 'Copy failed'; }
        setTimeout(() => (btn.textContent = 'Copy Link'), 1200);
      }));

      const webShareBtn = document.getElementById('webShareBtn');
      if (navigator.share && webShareBtn) {
        webShareBtn.classList.remove('hidden');
        webShareBtn.addEventListener('click', () => {
          navigator.share({ title: document.title, url });
        });
      }

      const sysShareBtn = document.getElementById('sysShareBtn');
      if (navigator.share && sysShareBtn) {
        sysShareBtn.addEventListener('click', () => {
          navigator.share({ title: document.title, url });
        });
      }

      const modal = document.getElementById('qrModal');
      const openers = [document.getElementById('qrBtn'), document.getElementById('qrBtn2')].filter(Boolean);
      const closer = document.getElementById('qrClose');
      openers.forEach(o => o.addEventListener('click', () => modal.classList.remove('hidden')));
      closer.addEventListener('click', () => modal.classList.add('hidden'));
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.add('hidden');
      });
    })();
  </script>
</body>
</html>
